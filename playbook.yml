---

- name: Ubuntu desktop environment playbook
  hosts: localhost
  environment:
    DEBIAN_FRONTEND: noninteractive
  roles:
    - { role: geerlingguy.docker, become: yes }

  tasks:
    - name: add apt repo for remmina
      become: true
      apt_repository:
        repo: ppa:remmina-ppa-team/remmina-next
    - name: Add the Google Cloud SDK distribution URI as a package source
      shell: echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      become: true
    - name: Import the Google Cloud Platform public key
      shell: curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
      become: true
    - name: Do apt-get update after adding Google Cloud SDK package source
      become: true
      apt:
        update-cache: yes
    - name: Install a list of packages
      become: true
      apt:
        name: "{{ packages }}"
      vars:
        packages:
          - jq
          - jo
          - iptables
          - sshuttle
          - remmina
          - remmina-plugin-rdp
          - remmina-plugin-secret
          - wireshark
          - cntlm
          - tree
          - direnv
          - bison
          - curl
          - grep
          - gzip
          - less
          - nmap
          - openssl
          - sshpass
          - tar
          - unzip
          - vim
          - wget
          - whois
          - zip
          # git credential helper
          - libsecret-1-0
          - libsecret-1-dev
          # END git credential helper
          - openconnect
          - nautilus-dropbox
          - net-tools
          - kazam
          - virtualbox
          - google-cloud-sdk
          - tmux
          - golang-cfssl
    - name: gather installed packages to check for Slack, Zoom, Chrome etc
      package_facts:
    - name: Install Slack.
      become: true
      apt:
        deb: https://downloads.slack-edge.com/linux_releases/slack-desktop-3.4.2-amd64.deb
      when: '"slack-desktop" not in ansible_facts.packages'
    - name: Install Zoom.
      become: true
      apt:
        deb: https://zoom.us/client/latest/zoom_amd64.deb
      when: '"zoom" not in ansible_facts.packages'
    - name: Install Chrome.
      become: true
      apt:
        deb: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      when: '"google-chrome-stable" not in ansible_facts.packages'

    - name: Set up libsecret for git credential helper
      command: make --directory=/usr/share/doc/git/contrib/credential/libsecret
      become: true
    - name: Set up git credential helper
      git_config:
        name: credential.helper
        scope: global
        value: /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret    
    - name: Set up git to suppress message on push
      git_config:
        name: push.default
        scope: global
        value: simple
    - name: update git config globally setting user.email
      git_config:
        name: user.email
        scope: global
        value: mc.matthew.cosgrove@gmail.com
    - name: update git config globally setting user.name
      git_config:
        name: user.name
        scope: global
        value: matthewcosgrove
    - name: update git config globally setting default editor
      git_config:
        name: core.editor
        scope: global
        value: vim
    - name: Ensure ssh key generated ready to upload to GitHub and GitLab
      command: ssh-keygen -t rsa -f "{{ ssh.key_pair_path }}" -N ''
      args:
        creates: "{{ ssh.key_pair_path }}"
    - name: check for creds-for-curl-gitlab.txt
      stat:
        path: 'creds-for-curl-gitlab.txt'
      register: credsforcurlgitlab
    - name: Ensure creds-for-curl-gitlab.txt is populated with GitLab access token which needs to be with scope api
      wait_for:
        path: creds-for-curl-gitlab.txt
        search_regex: .*PRIVATE-TOKEN:\s\w+
      when: credsforcurlgitlab.stat.exists
    - name: Upload SSH key to GitLab
      shell: KEY=$( cat {{ ssh.key_pair_path }}.pub );TITLE=${KEY/* };curl -X POST -K creds-for-curl-gitlab.txt -F "title=$TITLE" -F "key=$KEY" "https://gitlab.com/api/v4/user/keys"
      args:
        executable: /bin/bash
      when: credsforcurlgitlab.stat.exists
    - name: check for creds-for-curl-github.netrc
      stat:
        path: 'creds-for-curl-github.netrc'
      register: credsforcurlgithub
    - name: Wait until creds-for-curl-github.netrc is created from creds-for-curl-github.netrc.template and updated with GitHub access key with scope write:public_key
      wait_for:
        path: creds-for-curl-github.netrc
        search_regex: .*password\s\w+
      when: credsforcurlgithub.stat.exists
    - name: Upload SSH key to GitHub
      shell: KEY=$( cat {{ ssh.key_pair_path }}.pub );TITLE=${KEY/* };JSON=$( jo title="$TITLE" key="$KEY" );curl --netrc-file creds-for-curl-github.netrc -d "$JSON" https://api.github.com/user/keys
      args:
        executable: /bin/bash
      when: credsforcurlgithub.stat.exists
    - name: mkdir for gists
      file:
        path: ~/gists
        state: directory
    - name: Clone dotfiles gist
      git:
        repo: git@gist.github.com:f012f714f8a401f965c86f5bc648a300.git
        dest: ~/gists/dotfiles
        accept_hostkey: yes
        update: no
      become: no
    - name: symbolic links
      file:
        src: "~/gists/dotfiles/{{ item.dotfilename }}"
        path: "~/{{ item.dotfilename }}"
        state: link
      with_items:
        - { dotfilename: '.bash_aliases'}
        - { dotfilename: '.bashrc_extension'}
        - { dotfilename: '.env'}
        - { dotfilename: '.functions'}
        - { dotfilename: '.vimrc'}
    - name: extend bashrc
      lineinfile:
        path: ~/.bashrc
        regexp: '^source ~/.bashrc_extension'
        insertafter: EOF
        line: 'source ~/.bashrc_extension'
